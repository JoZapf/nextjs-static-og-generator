# docker-compose.yml â€“ Dynamic OG Image Generator
#
# Author:    Jo Zapf <https://jozapf.de>
# License:   MIT
# Version:   1.0.0
# Since:     2025-12
# Repo:      https://github.com/JoZapf/nextjs-static-og-generator

services:
  # Development server with hot-reload
  dev:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    command: sh -c "npm install && npm run dev"
    profiles:
      - dev

  # Build container - generates OG images and static site
  build:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    command: sh -c "npm install && npm run build"
    profiles:
      - build

  # Preview server - serves static output (run after build)
  preview:
    image: nginx:1.27-alpine
    volumes:
      - ./out:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    profiles:
      - preview

volumes:
  node_modules:
